# 托盘菜单新功能测试

## 新增功能

在托盘菜单中添加了两个开关选项：

1. **开机自启动** - 控制程序是否随 Windows 启动
2. **启动时最小化** - 控制程序启动时是否最小化到托盘

## 功能特性

- ✅ 启用时菜单项前面显示 **✓** 打勾标记
- ✅ 未启用时只显示标题文字
- ✅ 点击菜单项可以切换开关状态
- ✅ 切换后会显示通知提示
- ✅ 配置会自动保存到配置文件
- ✅ 自启动会同步更新 Windows 注册表

## 菜单结构

```
托盘菜单
├── 切换 Proxifier (默认双击操作)
├── 查看状态
├── ───────────────
├── 主界面
├── ───────────────
├── ✓ 开机自启动        (启用时显示打勾)
├── ✓ 启动时最小化      (启用时显示打勾)
├── ───────────────
└── 退出
```

## 测试步骤

### 1. 重启程序
由于修改了代码，需要重启程序：
- 右键托盘图标，选择"退出"
- 重新运行 `python run.py --dev`

### 2. 测试开机自启动
1. 右键托盘图标
2. 点击"开机自启动"
3. 观察：
   - 菜单项前面应该出现 ✓ 标记
   - 系统通知显示"开机自启动已启用"
4. 再次点击"开机自启动"
5. 观察：
   - ✓ 标记消失
   - 系统通知显示"开机自启动已禁用"

### 3. 测试启动时最小化
1. 右键托盘图标
2. 点击"启动时最小化"
3. 观察：
   - 菜单项前面应该出现 ✓ 标记
   - 系统通知显示"启动时最小化已启用"
4. 再次点击"启动时最小化"
5. 观察：
   - ✓ 标记消失
   - 系统通知显示"启动时最小化已禁用"

### 4. 验证配置持久化
1. 修改两个开关的状态
2. 退出程序
3. 重新启动程序
4. 右键托盘图标查看菜单
5. 确认：✓ 标记状态与上次设置一致

### 5. 验证自启动注册表
启用"开机自启动"后，可以通过以下方式验证：
1. 按 `Win + R`
2. 输入 `regedit` 打开注册表编辑器
3. 导航到：`HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
4. 查找名为 `ProxifierToggler` 的项
5. 确认其值为程序的可执行文件路径

## 实现细节

### 代码修改
- **文件**: `src/gui/tray_icon.py`
- **新增函数**:
  - `toggle_auto_start()` - 切换自启动状态
  - `toggle_minimize_on_startup()` - 切换最小化启动状态
  - `check_auto_start()` - 检查自启动状态（用于显示打勾）
  - `check_minimize_on_startup()` - 检查最小化启动状态（用于显示打勾）

### 依赖模块
- `src.utils.startup` - Windows 注册表操作
- `src.config.manager` - 配置文件读写

### 配置文件
配置保存在 `config/config.json`：
```json
{
    "auto_start": true,
    "start_minimized": true,
    ...
}
```

## 注意事项

1. **权限要求**: 修改注册表可能需要管理员权限
2. **错误处理**: 如果注册表操作失败，会显示错误通知并回滚配置
3. **菜单刷新**: pystray 会自动刷新菜单状态，无需手动刷新
4. **线程安全**: 所有操作都在托盘线程中执行，无需担心线程安全问题
