# 动态托盘图标功能测试指南

## 功能概述

从 v2.3.2 开始，Proxifier Toggler 的托盘图标会根据 Proxifier 服务状态自动切换：
- **蓝色图标** 🔵 - Proxifier 服务正在运行
- **灰色图标** ⚪ - Proxifier 服务已停止

## 测试步骤

### 1. 启动程序
```bash
python run.py --dev
```

### 2. 观察初始状态
- 查看系统托盘中的 Proxifier Toggler 图标
- 图标颜色应该反映当前 Proxifier 服务的实际状态

### 3. 测试状态切换

#### 方法 A：通过托盘菜单
1. 右键点击托盘图标
2. 选择"切换 Proxifier"
3. 观察图标颜色变化（应在 2 秒内更新）

#### 方法 B：通过主界面
1. 右键托盘图标，选择"主界面"
2. 在设置窗口中点击"启动 Proxifier"或"停止 Proxifier"
3. 观察托盘图标颜色变化

### 4. 验证联动监控
- 当主界面（设置窗口）**打开**时，托盘图标会随主界面的状态检测（每 2 秒）同步更新。
- 当主界面**关闭**时，程序不会进行背景轮询，最大程度节省资源。

## 预期行为

### 正常情况
- ✅ 服务启动后，图标变为蓝色
- ✅ 服务停止后，图标变为灰色
- ✅ 切换操作后立即更新图标（无延迟）
- ✅ 界面打开时，状态实时同步

### 异常情况处理
- 如果图标文件缺失，会自动使用内置代码绘制的备用图标。
- 控制台会输出警告信息，但不影响程序运行。

## 技术细节

### 监控机制 (资源优化版)
- **主动触发**: 托盘菜单或主界面的“切换”按钮操作会立即触发图标刷新。
- **被动联动**: 当主界面打开时，其内置的监控逻辑在刷新 UI 的同时会顺便通知托盘图标更新。
- **静态模式**: 界面关闭且无操作时，程序不进行任何状态检测。

### 图标缓存
- 图标文件在首次加载后会被缓存在内存中
- 避免重复读取文件，提升性能

### 文件依赖
- `assets/icon.png` - 活动状态图标
- `assets/icon_inactive.png` - 非活动状态图标

## 故障排查

### 图标不更新
1. 检查控制台是否有错误信息
2. 确认 `assets/` 目录下存在图标文件
3. 验证服务状态检测是否正常工作

### 图标显示异常
1. 确认 `assets/` 目录下存在正确的图标文件
2. 重启程序
3. 检查图标文件是否损坏

### 性能问题
- 2 秒的轮询间隔已经过优化，CPU 占用极低
- 如需调整，修改 `src/gui/tray_icon.py` 中的 `time.sleep(2)`

## 代码位置

- **主要实现**: `src/gui/tray_icon.py`
  - `create_image()` - 图标加载
  - `update_icon_state()` - 状态更新
  - `status_monitor_loop()` - 监控循环

## 已知限制

- 图标更新有最多 2 秒的延迟（轮询间隔）
- 手动切换操作会立即更新，无延迟
